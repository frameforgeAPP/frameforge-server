<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FrameForge Code Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', sans-serif;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl max-w-md w-full border border-gray-700">
        <h1 class="text-2xl font-bold text-white mb-6 text-center">FrameForge Code Manager</h1>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">Code Name</label>
                <input type="text" id="codeName" placeholder="PRO-2026"
                    class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-purple-500 outline-none font-mono uppercase">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">Max Uses (0 = Unlimited)</label>
                <input type="number" id="maxUses" value="1"
                    class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-purple-500 outline-none">
            </div>

            <button onclick="createCode()" id="btnCreate"
                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-purple-500/30">
                Create Code
            </button>
        </div>

        <div id="status" class="mt-6 text-center text-sm hidden"></div>
        <div id="authStatus" class="mt-2 text-center text-xs text-gray-600">Connecting...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, initializeFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCpDUf5X2FaXRfnQP9PdqASNfEeawtL2YU",
            authDomain: "frameforge-app.firebaseapp.com",
            projectId: "frameforge-app",
            storageBucket: "frameforge-app.firebasestorage.app",
            messagingSenderId: "824448340937",
            appId: "1:824448340937:web:edda1404d6d4ddb5b14e18",
            measurementId: "G-DY5KLHEGNH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Force long polling to avoid "offline" issues
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });

        // Auto-login anonymously
        signInAnonymously(auth)
            .then(() => {
                document.getElementById('authStatus').innerText = "Connected (Anonymous)";
                document.getElementById('authStatus').className = "mt-2 text-center text-xs text-green-500";
            })
            .catch((error) => {
                console.error("Auth Error:", error);
                document.getElementById('authStatus').innerText = "Auth Failed: " + error.message;
                document.getElementById('authStatus').className = "mt-2 text-center text-xs text-red-500";
            });

        window.createCode = async () => {
            const codeName = document.getElementById('codeName').value.trim().toUpperCase();
            const maxUses = parseInt(document.getElementById('maxUses').value);
            const statusEl = document.getElementById('status');
            const btn = document.getElementById('btnCreate');

            if (!codeName) {
                showStatus('Please enter a code name', 'text-red-400');
                return;
            }

            // Disable button
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            statusEl.innerHTML = 'Creating...';
            statusEl.className = 'mt-6 text-center text-sm text-gray-400 block';

            try {
                // Ensure we are authenticated
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }

                const codeRef = doc(db, "promo_codes", codeName);
                const docSnap = await getDoc(codeRef);

                if (docSnap.exists()) {
                    if (!confirm('Code already exists. Overwrite?')) {
                        showStatus('Cancelled', 'text-gray-400');
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        return;
                    }
                }

                await setDoc(codeRef, {
                    active: true,
                    maxUses: maxUses,
                    currentUses: 0,
                    createdAt: new Date().toISOString(),
                    type: 'lifetime'
                });

                showStatus(`Code <b>${codeName}</b> created successfully!`, 'text-green-400');
                document.getElementById('codeName').value = '';

            } catch (error) {
                console.error(error);
                let errorMsg = error.message;
                if (error.code === 'unavailable') errorMsg = "Client is offline (Network Error)";
                if (error.code === 'permission-denied') errorMsg = "Permission Denied (Check Rules)";

                showStatus('Error: ' + errorMsg, 'text-red-400');
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };

        function showStatus(msg, colorClass) {
            const el = document.getElementById('status');
            el.innerHTML = msg;
            el.className = `mt-6 text-center text-sm block ${colorClass}`;
        }
    </script>
</body>

</html>